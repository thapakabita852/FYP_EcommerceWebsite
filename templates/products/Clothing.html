{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clothing - A&K Accessories And Closet</title>
    <link rel="stylesheet" href="{% static 'css/explore.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      .wishlist-btn i.fas {
        color: #e91e63;
      }
      .wishlist-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #e91e63;
        color: white;
        border-radius: 50%;
        padding: 2px 5px;
        font-size: 10px;
      }
      .icon-link {
        position: relative;
        margin: 0 10px;
      }
      .action-btn.wishlist-btn i.fas {
        color: #e91e63;
      }
    </style>
  </head>

  <body>
    <header>
      <nav class="navbar">
        <div class="container">
          <div class="navbar-brand">
            <a href="{% url 'accounts:dashboard' %}">
              <h1>A&K</h1>
            </a>
          </div>
          <div class="navbar-toggle">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
          </div>
          <div class="navbar-menu">
            <ul class="navbar-nav">
              <li class="nav-item active">
                <a class="nav-link" href="{% url 'products:clothing' %}">Clothing</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'products:accessories' %}">Accessories</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'products:eco_friendly' %}">ECO-Friendly</a>
              </li>
            </ul>
            <a href="{% url 'wishlist:view_wishlist' %}" class="icon-link">
              <i class="fas fa-heart"></i>
              <span class="wishlist-count" id="wishlist-count">
                {% if wishlist_count %}{{ wishlist_count }}{% else %}0{% endif %}
              </span>
            </a>
            <a href="{% url 'cart:view_cart' %}" class="icon-link cart-icon">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count" id="cart-count">{% if cart_count %}{{ cart_count }}{% else %}0{% endif %}</span>
            </a>
            <a href="{% url 'accounts:logout' %}" class="icon-link">
              <i class="fas fa-sign-out"></i>
            </a>
          </div>
        </div>
      </nav>
    </header>

    <section class="hero">
      <div class="container">
        <h2>Discover Your Style</h2>
        <p>Explore our latest collection of trendy clothing items</p>
      </div>
    </section>

    <div class="promo-banner">
      <div class="container">
        <div class="promo-content">
          <span class="promo-tag">LIMITED OFFER</span>
          <h3>No Shipping Fees</h3>
          <p>Happy Shopping</p>
        </div>
      </div>
    </div>

    <main class="product-section">
      <div class="container">
        <div class="filter-toggle">
          <button id="filterToggleBtn">
            <i class="fas fa-filter"></i> Filter & Sort
          </button>
        </div>

        <div class="content-grid">
          <aside class="filters-sidebar">
            <div class="filters-header">
              <h3>Filters</h3>
              <button class="close-filters">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <form method="GET" action="{% url 'products:clothing' %}" class="filters-form">
              <!-- Filter groups remain the same -->
              <div class="filter-group">
                <h4>Sort By</h4>
                <select name="sort_by" id="sort_by">
                  <option value="default">Default</option>
                  <option value="price_low">Price: Low to High</option>
                  <option value="price_high">Price: High to Low</option>
                  <option value="newest">Newest Arrivals</option>
                </select>
              </div>

              <!-- Other filter groups... -->

            </form>
          </aside>

          <div class="products-grid">
            {% for product in products %}
            <div class="product-card">
              <div class="product-image">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" />
                {% else %}
                <img src="{% static 'images/default-image.jpg' %}" alt="No image available" />
                {% endif %}
                <div class="product-actions">
                  <button class="action-btn wishlist-btn"
                    onclick="toggleWishlist(this, '{% url 'wishlist:add_to_wishlist' product.id %}')"
                    title="Add to Wishlist">
                    <i class="far fa-heart"></i>
                  </button>
                  <button class="action-btn quickview-btn" title="Quick View">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                {% if product.on_sale %}
                <span class="product-badge sale">Sale</span>
                {% endif %}
                {% if product.is_new %}
                <span class="product-badge new">New</span>
                {% endif %}
              </div>
              <div class="product-info">
                <h3 class="product-title">{{ product.name }}</h3>
                <p class="product-price">
                  {% if product.on_sale %}
                  <span class="original-price">Rs.{{ product.original_price }}</span>
                  {% endif %}
                  <span class="current-price">Rs.{{ product.price }}</span>
                </p>
                <p class="product-description">{{ product.description }}</p>
                <button class="btn add-to-cart-btn"
                  onclick="addToCart('{% url 'cart:add_to_cart' product.id %}')">
                  Add to Cart
                </button>
              </div>
            </div>
            {% empty %}
            <div class="no-products">
              <i class="far fa-sad-tear"></i>
              <p>No products found matching your criteria.</p>
              <button class="btn btn-secondary" onclick="resetFilters()">
                Clear Filters
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </main>

    <script>
      // Store wishlist count in session storage
      function storeWishlistCount(count) {
        sessionStorage.setItem('wishlistCount', count);
      }

      function getStoredWishlistCount() {
        return sessionStorage.getItem('wishlistCount') || 0;
      }

      // Toggle Wishlist Function
      function toggleWishlist(button, url) {
        fetch(url, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'added') {
            button.innerHTML = '<i class="fas fa-heart"></i>';
            updateWishlistCount();
            if (data.wishlist_count) {
              storeWishlistCount(data.wishlist_count);
            }
          } else if (data.status === 'removed') {
            button.innerHTML = '<i class="far fa-heart"></i>';
            updateWishlistCount();
            if (data.wishlist_count) {
              storeWishlistCount(data.wishlist_count);
            }
          } else if (data.status === 'exists') {
            button.innerHTML = '<i class="fas fa-heart"></i>';
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      // Update Wishlist Count
      function updateWishlistCount() {
        fetch("{% url 'wishlist:get_wishlist_count' %}", {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
          },
        })
        .then(response => response.json())
        .then(data => {
          const wishlistCountElement = document.getElementById("wishlist-count");
          if (wishlistCountElement) {
            wishlistCountElement.textContent = data.wishlist_count;
            storeWishlistCount(data.wishlist_count);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      // Cart Functions
      function addToCart(url) {
        fetch(url, {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
        .then((response) => {
          if (response.ok) {
            updateCartCount();
          } else {
            console.error("Failed to add product to cart.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
      }

      function updateCartCount() {
        fetch("{% url 'cart:get_cart_count' %}", {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
        .then((response) => response.json())
        .then((data) => {
          const cartCountElement = document.getElementById("cart-count");
          if (cartCountElement) {
            cartCountElement.textContent = data.cart_count;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Load wishlist count from session storage
        const storedCount = getStoredWishlistCount();
        const wishlistCountElement = document.getElementById("wishlist-count");
        if (wishlistCountElement && storedCount) {
          wishlistCountElement.textContent = storedCount;
        }

        // Check if products are already in wishlist and update heart icons
        {% if user.is_authenticated %}
          {% for product in products %}
            {% if product.in_wishlist %}
              document.querySelectorAll(`button[onclick*="{% url 'wishlist:add_to_wishlist' product.id %}"]`).forEach(btn => {
                btn.innerHTML = '<i class="fas fa-heart"></i>';
              });
            {% endif %}
          {% endfor %}
        {% endif %}
      });

      function resetFilters() {
        document.querySelector('.filters-form').reset();
        document.querySelector('.filters-form').submit();
      }
    </script>
  </body>
</html>